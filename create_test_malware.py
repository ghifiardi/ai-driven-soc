#!/usr/bin/env python3
"""
Create Test Malware Files for Threat Detection Testing
Creates sample files that will trigger YARA rules for testing purposes.
"""

import os
import hashlib
from pathlib import Path

def create_test_files():
    """Create test files that will match YARA rules."""
    test_dir = Path("data/test_malware")
    test_dir.mkdir(parents=True, exist_ok=True)
    
    test_files = {
        "test_ransomware.txt": """
This is a test ransomware file for threat hunting testing.
The file contains keywords: encrypt, ransom, decrypt
This should trigger the Test_Ransomware_Signature YARA rule.
""",
        "test_backdoor.txt": """
Test backdoor file for detection testing.
Contains: cmd.exe, /c, powershell, -encodedcommand, backdoor
This should trigger the Test_Backdoor_Detection YARA rule.
""",
        "test_webshell.txt": """
Test webshell file for detection.
Contains: eval(, base64_decode, system(, exec(, shell_exec
This should trigger the Test_Webshell_Detection YARA rule.
""",
        "test_cryptominer.txt": """
Test cryptocurrency miner file.
Contains: mining, cryptocurrency, bitcoin, mining_pool, stratum
This should trigger the Test_CryptoMiner_Detection YARA rule.
""",
        "test_suspicious.txt": """
Test suspicious process file.
Contains: suspicious_process, malware_signature, test_threat
This should trigger the Test_Suspicious_Process YARA rule.
""",
        "test_hash_match.txt": """
Test file hash matching.
Contains: test_malware_hash, known_bad_hash
This should trigger the Test_File_Hash_Match YARA rule.
"""
    }
    
    print("=" * 60)
    print("Creating Test Malware Files")
    print("=" * 60)
    print()
    
    created_files = []
    for filename, content in test_files.items():
        filepath = test_dir / filename
        with open(filepath, 'w') as f:
            f.write(content)
        
        # Calculate hash
        with open(filepath, 'rb') as f:
            file_hash = hashlib.sha256(f.read()).hexdigest()
        
        created_files.append({
            "filename": filename,
            "path": str(filepath),
            "sha256": file_hash,
            "size": len(content)
        })
        
        print(f"✓ Created: {filename}")
        print(f"  Path: {filepath}")
        print(f"  SHA256: {file_hash}")
        print()
    
    # Create IOC file with hashes
    ioc_file = test_dir / "test_iocs.json"
    import json
    iocs = {
        "file_hashes": {
            file_info["sha256"]: f"Test malware: {file_info['filename']}"
            for file_info in created_files
        },
        "ips": ["192.168.1.100", "10.0.0.50"],
        "domains": ["test-malware.example.com", "suspicious-domain.test"]
    }
    
    with open(ioc_file, 'w') as f:
        json.dump(iocs, f, indent=2)
    
    print(f"✓ Created IOC file: {ioc_file}")
    print()
    print("=" * 60)
    print("Test Files Created Successfully!")
    print("=" * 60)
    print()
    print("Files created:")
    for file_info in created_files:
        print(f"  - {file_info['filename']} ({file_info['size']} bytes)")
    print()
    print("You can now test THOR detection with:")
    print(f"  python thor_endpoint_agent.py --config config/thor_config.json --scan-type filesystem --target {test_dir}")
    print()
    
    return created_files

if __name__ == "__main__":
    create_test_files()

